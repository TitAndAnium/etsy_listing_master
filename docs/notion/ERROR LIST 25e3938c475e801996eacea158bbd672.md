# ERROR LIST

*Notion-vriendelijk. Elke taak heeft duidelijke acceptance criteria, ownersuggestie en context voor uitvoering.*

---

## 0) Werkwijze en context voor Cascade (1x doen)

- [ ]  **Maak feature branch aan:** `fix/security-auth-credits-rules`
- [ ]  **Zet prompt_version bump klaar:** verhoog `prompt_version` naar `v2.3.1` in alle relevante logpayloads.
- [ ]  **Activeer Backfire Sentry (auditmodus):** log onder elke run: `fallback_model_used:null`, `retry_reason` alleen bij echte fallback, `prompt_version`, `token_usage`, `timestamp`.
- [ ]  **Testmatrix bevestigen:** Unit, Emulator, E2E (preview) en optioneel ‚Äúfull‚Äù integratie.
- [ ]  **Deploy-stap aan eind:** `firebase deploy --only functions` (en Hosting zodra frontend mee mag).
    
    **DoD:** branch bestaat, auditlogging zichtbaar, alle testsuites geconfigureerd, CI groen op branch.
    

---

## 1) Auth verplicht op alle generate-endpoints (Hoog)

**Doel:** Alleen geauthenticeerde gebruikers mogen AI-generatie aanroepen. `uid` wordt server-side uit ID-token gehaald. Geen `'unknown'` of client-aangeleverde `uid` meer.

**Te wijzigen (indicatief):**

- HTTP functions voor generatie, bijv. `api_generateListingFromDump`, `api_generateChainingFromFields`, `api_generateListingField` (alle onRequest/HTTP ingangen).
- Shared auth-middleware: `authValidator(req)` die Firebase ID token verifieert en `req.user = { uid }` zet.

**Stappen (technisch):**

- [ ]  Voeg `verifyIdToken` toe (Firebase Admin) aan een **authMiddleware**.
- [ ]  Pas alle generate handlers aan: **verwijder** client-`uid` uit payload, **gebruik** `req.user.uid`.
- [ ]  Vervang alle interne calls naar core/functies die `uid` vragen, door `uid` uit context (nooit uit body/query).
- [ ]  **CORS** blijft actief, maar autorisatie is leidend: geen token -> 401.
- [ ]  Logging: schrijf `uid` uit token naar logs; `'unknown'` mag nergens meer voorkomen.

**Tests:**

- [ ]  Unit: middleware geeft 401 zonder/ongeldig token, 200 met geldig token.
- [ ]  Emulator/E2E: ongeauth. call -> 401; geauth. -> 200; logs tonen juiste `uid`.
- [ ]  Negatief: client die `uid` probeert te spoofen in body -> wordt genegeerd.

**Acceptance criteria:**

- [ ]  Alle generate-endpoints returnen **401** als geen geldig ID-token.
- [ ]  In logs en credits komt **nooit** `'unknown'` of body-uid voor.
- [ ]  Cypress/E2E scenario‚Äôs slagen met geauth. flow.

**Owner-suggestie:** Security Engineer / Backend.

---

## 2) Persistente per-user Daily Credits via Firestore-transactie (Hoog)

**Doel:** Daglimiet credits is **concurrent-safe en persistent** (geen in-memory buckets).

**Te wijzigen:**

- `utils/credits.js` (of gelijkwaardig): implementeer `ensureCredits`, `getBalance`, `consumeCredits` met **Firestore**.
- Firestore-schema: collectie `user_credits` of `users/{uid}/usage/{YYYYMMDD}`.

**Stappen (technisch):**

- [ ]  **Schema:** Kies simpel 1 doc per user: `user_credits/{uid}` met velden `creditsUsed:number`, `lastReset:date`.
- [ ]  **Transaction flow `consumeCredits(uid, amount)`:**
    - Lees doc in transactie.
    - Als `lastReset < startOfToday` -> reset `creditsUsed=0`, update `lastReset=today`.
    - Als `creditsUsed + amount > DAILY_CREDITS` -> throw (HTTP 429).
    - Anders: `FieldValue.increment(amount)`.
- [ ]  **ensureCredits(uid):** bestaansgarantie en dag-reset.
- [ ]  Vervang alle **in-memory** references; verwijder test-state leak helpers (of houd alleen voor unit-mocks).
- [ ]  Logging: log credit-mutaties (voor runSummary).

**Tests:**

- [ ]  Unit (gemockte Firestore): happy path, limiet overschrijding, dag-reset.
- [ ]  Concurrency: 2 gelijktijdige `consumeCredits(uid, amount)` -> √©√©n commit, √©√©n abort/retry. E2E met emulator waar mogelijk.
- [ ]  E2E: na n runs bereikt user limiet -> **429 Daily credits exhausted**.

**Acceptance criteria:**

- [ ]  Geen enkel pad gebruikt nog in-memory buckets in productie.
- [ ]  Race-conditions voorkomen (transactioneel).
- [ ]  429 wanneer limiet overschreden. Daggrens reset correct.
- [ ]  Tests groen in CI.

**Owner-suggestie:** Backend/Database Engineer.

---

## 3) Server-side validatie bedrag ‚Üî credits (Stripe) (Hoog)

**Doel:** Client kan **niet** zelf `credits` of `amount_cents` bepalen. Alleen **server-gedefinieerde** producten/pakketten of serverberekening toegestaan.

**Te wijzigen:**

- Handler `api_createCheckoutSession` en Stripe webhook consumer.

**Stappen (technisch):**

- [ ]  **Verwijder** directe trust op body `{credits, amount_cents}`.
- [ ]  Implementeer **server mapping**:
    - Optie A (aanbevolen): vaste Stripe **Price IDs** voor pakketten, bijv. `price_100c`, `price_250c`, `price_500c`.
    - Optie B: server berekent credits uit bedrag (fixed ratio), **maar** verifieert in webhook `amount_total` en `currency`.
- [ ]  In **CheckoutSession**: client stuurt alleen `packageId` (of `priceId`). Server zet line_items.
- [ ]  In **webhook**:
    - Verifieer signature (bestaat al).
    - Bepaal **creditsToAdd** uitsluitend server-side (op basis van `priceId` of `amount_total`). **Negeer** metadata-credits van client.
    - Idempotency: markeer processed events (bijv. opslaan `session.id`) zodat dubbele webhook geen dubbele credits boekt.

**Tests:**

- [ ]  Unit: POST met mismatch body wordt **400** (client bepaalt niets).
- [ ]  Webhook: accepted event verhoogt credits exact volgens mapping; duplicate webhook heeft **geen** extra effect.
- [ ]  E2E: koop ‚Äú100 credits‚Äù pakket -> credits +100, bedrag exact gelijk aan prijs.

**Acceptance criteria:**

- [ ]  Client kan credits/bedrag **niet** manipuleren.
- [ ]  Webhook creditering is idempotent en uitsluitend server-gedefinieerd.
- [ ]  Mapping gedocumenteerd (README + `.env.example` of constants).

**Owner-suggestie:** Payments Specialist / Backend.

---

## 4) Firestore Security Rules finaliseren + testen (Hoog)

**Doel:** Least-privilege toegang. Gebruiker ziet enkel **eigen** data. Logs/metrics enkel via Functions/Admin. Geen brede reads.

**Te wijzigen:**

- `firestore.rules` en evt. `firestore.indexes.json`.

**Stappen (technisch):**

- [ ]  **Users data:**
    
    ```
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    ```
    
- [ ]  **Credits usage (`user_credits`):** alleen eigenaar lezen (schrijven **alleen** via Functions/Admin).
- [ ]  **Logs / runs / admin-collecties:** `allow read, write: if false;` en alleen via Admin SDK (Cloud Functions).
- [ ]  **Publieke config (indien nodig):** strikt read-only, zonder PII.
- [ ]  **Emulator tests:** schrijf lees/schrijf scenario‚Äôs (eigen vs. andermans data), moeten correct **denied** worden voor client.
- [ ]  Documenteer uitzonderingen (admin claims) en voeg tests toe.

**Tests:**

- [ ]  Rules unit via emulator: matrix van read/write paden.
- [ ]  Frontend rooktest: geen directe Firestore calls die nu breken; waar nodig omzetten naar Functions.

**Acceptance criteria:**

- [ ]  Alle paden hebben expliciete regels (deny-by-default waar gepast).
- [ ]  Client ziet nooit andermans user/credit/log data.
- [ ]  Alle rule-tests groen in CI.

**Owner-suggestie:** Data Protection Officer / Backend.

---

## 5) Opruimen `uid` en logging-consistentie (afgeleid van 1) (Midden)

**Doel:** Geen `'unknown'` of `testuser123` restanten. Overal **consistente** `uid` uit token.

**Stappen:**

- [ ]  Zoek/vervang alle plekken met `'unknown'` of hardcoded test-uids.
- [ ]  Logpayloads controleren: `uid` verplicht veld bij user-acties.
- [ ]  E2E: logrecords tonen juiste uid.

**Acceptance criteria:**

- [ ]  Geen hardcoded uids in code.
- [ ]  Logs consistent met geauthenticeerde gebruiker.

**Owner-suggestie:** Backend.

---

# Contextpakket per taak (copy-paste voor Cascade)

## Context_strategy (JSON, generiek voor alle 4 Hoogs)

```json
{
  "objective": "Elimineren van blokkerende security- en betaalfouten voor production readiness.",
  "scope": [
    "Auth op alle generate endpoints",
    "Persistente per-user daily credits via Firestore transacties",
    "Server-side validatie bedrag<->credits (Stripe)",
    "Firestore security rules least-privilege + emulator tests"
  ],
  "constraints": {
    "no_model_fallback_to_gpt_3_5": true,
    "ascii_only_output": true,
    "max_tags": 13,
    "max_title_chars": 140
  },
  "logging_contract": {
    "required": ["prompt_version","token_usage","retry_reason?","fallback_model_used?","quality_score?","timestamp","uid"],
    "notes": "retry_reason en fallback_model_used alleen setten indien van toepassing; uid uit ID-token; quality_score alleen bij geslaagde veldlogs"
  },
  "ci_matrix": ["unit","firestore_rules_emulator","e2e_preview","optional_full_emulator"],
  "env_vars": ["OPENAI_API_KEY","SLACK_WEBHOOK_URL","STRIPE_SECRET_KEY","STRIPE_WEBHOOK_SECRET","DAILY_CREDITS","DAILY_BUDGET_USD","BUDGET_HARD_STOP","BASE_URL"],
  "rollback": "Feature branch; geen schema-breaking wijzigingen; revert via git; rules rollback via vorige deployed rules file"
}

```

## Instructievertaling voor Cascade (per hoofdpunt, 1 stap)

**üìà Strategie:** Sluit misbruikgaten en maak quota en betalingen onomzeilbaar.

**üß≠ Stap (nu uitvoeren):** Implementeer auth-middleware op alle generate-endpoints en vervang client-uid door token-uid.

**üí¨ Jip-en-Janneke:** Iedereen moet eerst inloggen; we lezen het gebruikersnummer uit het inlogbewijs. Zonder inlog geen toegang.

**‚ùì Validatievraag:** Zie je in de logs dat `uid` overal uit het ID-token komt en dat een anonieme call 401 geeft?

(Voer daarna stapgewijs taken 2, 3 en 4 uit met dezelfde structuur.)

---

# Checklist .env / CI / Deploy (ondersteunend)

- [ ]  `.env.example` updaten: **verwijder** client-credits velden, voeg `STRIPE_PRICE_IDS` of mapping toe.
- [ ]  `functions:config:set stripe.secret=... stripe.webhook_secret=...` in README opnemen.
- [ ]  CI workflow: voeg rules-tests en webhook idempotency test toe.
- [ ]  Deploy: Functions (en Hosting zodra frontend klaar is).

---

# Definition of Done ‚Äì totaal

- [ ]  Ongeauthenticeerde generate-requests geven **401**.
- [ ]  `uid` komt **altijd** uit ID-token, nooit uit request body.
- [ ]  Daily credits zijn **persistent** en **transactioneel** (429 bij overschrijding).
- [ ]  Stripe: **server-side** prijs/credits mapping, webhook **idempotent**, client kan niets forceren.
- [ ]  Firestore rules: **least-privilege**, emulator-tests groen.
- [ ]  CI **groen**, inclusief nieuwe tests; deploy uitgevoerd.